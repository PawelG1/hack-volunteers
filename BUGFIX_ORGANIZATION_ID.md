# Bug Fix: Wydarzenia bez organizationId

## ğŸ› Problem

Organizator po utworzeniu wydarzenia nie widziaÅ‚ go na swojej liÅ›cie, a wolontariusz po zapisaniu siÄ™ na wydarzenie nie byÅ‚ widoczny w zgÅ‚oszeniach.

## ğŸ” Diagnoza

### Problem 1: Brak `organizationId` w nowych wydarzeniach
Wydarzenia tworzone przez organizacjÄ™ nie miaÅ‚y ustawionego pola `organizationId`, co powodowaÅ‚o:
- `organizationId = null` w bazie danych
- Aplikacje wolontariuszy byÅ‚y tworzone z `organizationId: 'unknown'`
- NiemoÅ¼noÅ›Ä‡ powiÄ…zania wydarzeÅ„ z organizacjÄ…

**Kod przed poprawkÄ… (`add_event_page.dart`):**
```dart
final event = VolunteerEvent(
  id: '',
  title: _titleController.text.trim(),
  description: _descriptionController.text.trim(),
  organization: _organizationController.text.trim(),
  // âŒ BRAK organizationId!
  location: _locationController.text.trim(),
  // ... reszta pÃ³l
);
```

### Problem 2: Brak filtrowania wydarzeÅ„ po `organizationId`
Repository zwracaÅ‚o WSZYSTKIE wydarzenia zamiast filtrowaÄ‡ po ID organizacji.

**Kod przed poprawkÄ… (`organization_repository_impl.dart`):**
```dart
// For now, return ALL events (later we'll add proper organization filtering)
// TODO: Filter by organizationId when we have proper organization management
print('ğŸ“‹ REPO: Returning all ${allEvents.length} events');
return Right(allEvents); // âŒ Zwraca WSZYSTKIE wydarzenia!
```

## âœ… RozwiÄ…zanie

### Poprawka 1: Dodanie `organizationId` przy tworzeniu wydarzenia

**Plik:** `lib/features/organizations/presentation/pages/add_event_page.dart`

```dart
final event = VolunteerEvent(
  id: '', // Will be generated by repository
  title: _titleController.text.trim(),
  description: _descriptionController.text.trim(),
  organization: _organizationController.text.trim(),
  organizationId: 'sample-org', // âœ… TODO: Get from authenticated organization
  location: _locationController.text.trim(),
  date: _selectedDate,
  endDate: _selectedEndDate,
  requiredVolunteers: int.parse(_requiredVolunteersController.text),
  categories: _selectedCategories,
  contactEmail: _contactEmailController.text.trim().isEmpty 
      ? null 
      : _contactEmailController.text.trim(),
  contactPhone: _contactPhoneController.text.trim().isEmpty 
      ? null 
      : _contactPhoneController.text.trim(),
  imageUrl: imageUrl,
  status: _selectedStatus,
  createdAt: DateTime.now(),
);
```

**Zmiana:** Dodano `organizationId: 'sample-org'` (tymczasowo hardcoded, docelowo z autentykacji)

### Poprawka 2: Filtrowanie wydarzeÅ„ po `organizationId`

**Plik:** `lib/features/organizations/data/repositories/organization_repository_impl.dart`

```dart
@override
Future<Either<Failure, List<VolunteerEvent>>> getOrganizationEvents(String organizationId) async {
  try {
    print('ğŸ“‹ REPO: Getting organization events for organizationId: $organizationId');
    final allEventModels = await eventsLocalDataSource.getAllEvents();
    print('ğŸ“‹ REPO: Found ${allEventModels.length} total events in Isar');
    
    // Convert models to entities
    final allEvents = allEventModels.map((model) => model.toEntity()).toList();
    
    // âœ… Filter by organizationId
    final organizationEvents = allEvents.where((event) {
      return event.organizationId == organizationId;
    }).toList();
    
    print('ğŸ“‹ REPO: Filtered to ${organizationEvents.length} events for organizationId: $organizationId');
    for (final event in organizationEvents) {
      print('   - ${event.title} (id: ${event.id}, org: ${event.organization}, orgId: ${event.organizationId})');
    }
    
    return Right(organizationEvents);
  } catch (e) {
    print('ğŸ“‹ REPO: Error getting organization events: $e');
    return Left(CacheFailure('Failed to get organization events: ${e.toString()}'));
  }
}
```

**Zmiana:** Dodano filtrowanie `where((event) => event.organizationId == organizationId)`

## ğŸ“‹ Workflow po poprawce

### 1. Organizator tworzy wydarzenie
```
AddEventPage â†’ CreateNewEvent
  â†“
VolunteerEvent(organizationId: 'sample-org') â† âœ… Ustawiony organizationId
  â†“
OrganizationRepositoryImpl.createEvent()
  â†“
Isar (zapisane z organizationId: 'sample-org')
```

### 2. Organizator widzi swoje wydarzenia
```
ManageEventsPage â†’ LoadOrganizationEvents('sample-org')
  â†“
OrganizationRepositoryImpl.getOrganizationEvents('sample-org')
  â†“
Filtruje: gdzie organizationId == 'sample-org' â† âœ… Zwraca tylko wydarzenia organizacji
  â†“
UI wyÅ›wietla TYLKO wydarzenia tej organizacji
```

### 3. Wolontariusz aplikuje na wydarzenie
```
VolunteerSwipePage â†’ SwipeRight (eventId: 'xyz')
  â†“
EventsRepositoryImpl.applyForEvent(eventId: 'xyz', volunteerId: 'v123')
  â†“
Pobiera event z Isar (ma organizationId: 'sample-org')
  â†“
OrganizationLocalDataSource.createApplication(
  eventId: 'xyz',
  volunteerId: 'v123',
  organizationId: 'sample-org' â† âœ… PrawidÅ‚owe organizationId
)
  â†“
VolunteerApplication zapisana do Isar z organizationId: 'sample-org'
```

### 4. Organizator widzi aplikacje wolontariuszy
```
ApplicationsListPage â†’ LoadOrganizationApplications('sample-org')
  â†“
OrganizationRepositoryImpl.getOrganizationApplications('sample-org')
  â†“
OrganizationLocalDataSource.getApplicationsByOrganization('sample-org')
  â†“
Filtruje: gdzie organizationId == 'sample-org' â† âœ… Zwraca aplikacje organizacji
  â†“
UI wyÅ›wietla zgÅ‚oszenia wolontariuszy
```

## ğŸ”§ Wymagane DziaÅ‚ania

### 1. **HOT RESTART aplikacji** âš ï¸
```bash
# W terminalu Flutter naciÅ›nij:
R
```
Lub:
```bash
flutter run --uninstall-first
```

**UWAGA:** Hot reload (r) NIE zadziaÅ‚a! Trzeba zrobiÄ‡ hot restart (R).

### 2. **Wyczyszczenie starych danych** (OPCJONALNE)
Stare wydarzenia majÄ… `organizationId: null`. MoÅ¼esz:

**Opcja A: UsunÄ…Ä‡ aplikacjÄ™ i zainstalowaÄ‡ od nowa**
```bash
flutter run --uninstall-first
```

**Opcja B: DodaÄ‡ migracjÄ™ danych** (bardziej profesjonalne)
ZaktualizowaÄ‡ stare wydarzenia w bazie danych:
```dart
// W jakiejÅ› metodzie inicjalizacyjnej
final allEvents = await isar.volunteerEventModels.where().findAll();
await isar.writeTxn(() async {
  for (final event in allEvents) {
    if (event.organizationId == null) {
      // Przypisz domyÅ›lnÄ… organizacjÄ™ lub usuÅ„
      await isar.volunteerEventModels.delete(event.id);
    }
  }
});
```

## ğŸ§ª Testowanie

### Test 1: Utworzenie wydarzenia
1. Zaloguj jako organizacja
2. PrzejdÅº do "ZarzÄ…dzaj Wydarzeniami"
3. UtwÃ³rz nowe wydarzenie "Test Event"
4. **SprawdÅº logi:**
   ```
   ğŸ’¾ ISAR_IMPL: Saving event [id] - Test Event
   ```
5. **Powinno pojawiÄ‡ siÄ™ na liÅ›cie organizacji**

### Test 2: Filtrowanie wydarzeÅ„
1. PozostaÅ„ na stronie "ZarzÄ…dzaj Wydarzeniami"
2. **SprawdÅº logi:**
   ```
   ğŸ“‹ REPO: Getting organization events for organizationId: sample-org
   ğŸ“‹ REPO: Found X total events in Isar
   ğŸ“‹ REPO: Filtered to Y events for organizationId: sample-org
   ```
3. **Liczba Y powinna byÄ‡ mniejsza lub rÃ³wna X**

### Test 3: Aplikacja wolontariusza
1. Zaloguj jako wolontariusz
2. ZnajdÅº "Test Event" na swipeable cards
3. Swipnij w prawo (zapisz siÄ™)
4. **SprawdÅº logi:**
   ```
   âœ… Application created and saved: [app_id]
      Event: [event_id]
      Volunteer: [volunteer_id]
      Organization: sample-org â† âœ… NIE 'unknown'!
      Status: ApplicationStatus.pending
   ```

### Test 4: WidocznoÅ›Ä‡ aplikacji
1. WrÃ³Ä‡ do organizacji
2. PrzejdÅº do "ZgÅ‚oszenia Wolontariuszy"
3. **PowinieneÅ› zobaczyÄ‡ aplikacjÄ™ z Test 3**
4. **SprawdÅº logi:**
   ```
   Aplikacja powinna byÄ‡ widoczna z status: pending
   ```

## ğŸ“ TODO - PrzyszÅ‚e Ulepszenia

1. **Autentykacja organizacji**
   - Zamiast hardcoded `'sample-org'` pobieraÄ‡ z zalogowanej sesji
   - `organizationId: AuthService.currentOrganization?.id ?? 'unknown'`

2. **Validacja organizationId**
   - DodaÄ‡ walidacjÄ™ w repository przed zapisem
   - RzuciÄ‡ bÅ‚Ä…d jeÅ›li `organizationId == null`

3. **Migracja starych danych**
   - DodaÄ‡ skrypt do aktualizacji starych wydarzeÅ„
   - Lub usunÄ…Ä‡ je podczas pierwszego uruchomienia z nowÄ… wersjÄ…

4. **Testy jednostkowe**
   - Test tworzenia wydarzenia z organizationId
   - Test filtrowania po organizationId
   - Test aplikacji wolontariusza z poprawnym organizationId

## ğŸ“Š Stan KomponentÃ³w

| Komponent | Status | Notatki |
|-----------|--------|---------|
| AddEventPage | âœ… FIXED | Dodano organizationId |
| OrganizationRepositoryImpl | âœ… FIXED | Dodano filtrowanie |
| EventsRepositoryImpl | âœ… OK | JuÅ¼ uÅ¼ywaÅ‚ organizationId z eventu |
| OrganizationLocalDataSource | âœ… OK | Poprawnie filtruje po organizationId |
| VolunteerApplicationModel | âœ… OK | Ma pole organizationId |
| Isar Schema | âœ… OK | ObsÅ‚uguje nullable organizationId |

## ğŸ¯ Rezultat

Po wprowadzeniu poprawek:

âœ… **Organizator widzi TYLKO swoje wydarzenia**  
âœ… **Wolontariusz moÅ¼e siÄ™ zapisaÄ‡ na wydarzenie**  
âœ… **Aplikacja ma poprawny organizationId (nie 'unknown')**  
âœ… **Organizator widzi zgÅ‚oszenia wolontariuszy**  
âœ… **Koordynator moÅ¼e zatwierdzaÄ‡ i generowaÄ‡ certyfikaty**

---

**Data poprawki:** 2025-10-05  
**Autor:** AI Assistant  
**Priorytet:** ğŸ”´ CRITICAL (BlokujÄ…cy podstawowÄ… funkcjonalnoÅ›Ä‡)
